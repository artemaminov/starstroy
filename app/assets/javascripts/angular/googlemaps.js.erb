(function () {

  var app = angular.module("starstroy", ['ngMap', 'ngRoute']);

  app.config(function ($routeProvider, $locationProvider) {
    $locationProvider.html5Mode(true);
    $routeProvider
        .when('/', {
          templateUrl: '<%= asset_path('angular/templates/blocks_list.html') %>',
          controller: 'blockCtrl'
        })
        .when('/block/:id', {
          templateUrl: '<%= asset_path('angular/templates/block.html') %>',
          controller: 'blockCtrl'
        })
  });

  function mapProvider($http) {
    return {
      markers: function (id) {
        if (id == null) {
          return $http.get('blocks.json');
        } else {
          return $http.get("block/" + id + ".json");
        }
      },
      map: {}
    };
  }
  app.factory("mapProvider", ["$http", mapProvider]);

  function mapCtrl($scope, mapProvider) {
    mapProvider.markers().then(function (response) {
      $scope.markers = response.data;
    });
    $scope.$on('mapInitialized', function (event, map) {
      mapProvider.map = map;
    });
    $scope.iconChoose = function (date) {
      return (new Date(date) > Date.now()) ? '<%= asset_path('map-icn-inprogress.png') %>' : '<%= asset_path('map-icn-ready.png') %>';
    };
  }
  app.controller("mapCtrl", ["$scope", "mapProvider", mapCtrl]);

  function blockCtrl($scope, $routeParams, mapProvider) {
    mapProvider.markers($routeParams.id).then(function (response) {
      $scope.markers = response.data;
    });
    $scope.markerZoom = function (id, lat, lng) {
      mapProvider.map.panTo({lat: parseFloat(lat), lng: parseFloat(lng)});
      //mapProvider.map.setZoom(16);
    }
  }
  app.controller("blockCtrl", ["$scope", "$routeParams", "mapProvider", blockCtrl]);

  function navigationCtrl($scope, mapProvider) {
    $scope.currentTab = 1;
    $scope.tab = function (tab) {
      $scope.currentTab = tab;
    };
    $scope.tabClass = function (current) {
      if ($scope.currentTab == current) return "current"
    };
    $scope.backBtn = function () {
      mapProvider.markers().then(function (response) {
        $('.blocks').html(response.data);
      });
    };
  }
  app.controller("navigationCtrl", ["$scope", "mapProvider", navigationCtrl]);

})();
